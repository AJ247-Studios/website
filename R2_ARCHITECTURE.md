# R2 Upload Flow Architecture

## ğŸ“Š Complete Upload Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ UploadForm   â”‚  User selects file & submits                 â”‚
â”‚  â”‚ Component    â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â”‚ POST /api/upload                                      â”‚
â”‚         â”‚ FormData { file, title, description, user_id }        â”‚
â”‚         â–¼                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       NEXT.JS API                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  app/api/upload/route.ts                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. Receive FormData                                     â”‚  â”‚
â”‚  â”‚  2. Convert File â†’ Buffer                                â”‚  â”‚
â”‚  â”‚  3. Generate unique key                                  â”‚  â”‚
â”‚  â”‚     â””â”€â–º generateFileKey(filename, "media")               â”‚  â”‚
â”‚  â”‚         Returns: "media/1234567890_abc123_file.jpg"      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  4. Upload to R2                                         â”‚  â”‚
â”‚  â”‚     â””â”€â–º uploadToR2(buffer, key, contentType)             â”‚  â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚  â”‚         â”‚ AWS SDK S3 PutObjectCommand            â”‚       â”‚  â”‚
â”‚  â”‚         â”‚ Endpoint: R2_ENDPOINT                  â”‚       â”‚  â”‚
â”‚  â”‚         â”‚ Bucket: aj247-media                    â”‚       â”‚  â”‚
â”‚  â”‚         â”‚ Credentials: Access Key ID/Secret      â”‚       â”‚  â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚  â”‚         Returns: Public URL                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  5. Save metadata to Supabase                            â”‚  â”‚
â”‚  â”‚     â””â”€â–º Insert into `files` table                        â”‚  â”‚
â”‚  â”‚     â””â”€â–º Insert into `media` table (legacy)               â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  6. Return response                                      â”‚  â”‚
â”‚  â”‚     { success: true, file: {...}, media: {...} }         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                      â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLOUDFLARE R2   â”‚   â”‚    SUPABASE      â”‚      â”‚    SUPABASE      â”‚
â”‚                  â”‚   â”‚   files table    â”‚      â”‚   media table    â”‚
â”‚  Bucket:         â”‚   â”‚                  â”‚      â”‚                  â”‚
â”‚  aj247-media     â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                  â”‚   â”‚  â”‚ File       â”‚  â”‚      â”‚  â”‚ Media      â”‚  â”‚
â”‚  Object:         â”‚   â”‚  â”‚ Metadata   â”‚  â”‚      â”‚  â”‚ Record     â”‚  â”‚
â”‚  media/          â”‚   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚      â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  1234567890_     â”‚   â”‚  â”‚ id         â”‚  â”‚      â”‚  â”‚ id         â”‚  â”‚
â”‚  abc123_file.jpg â”‚   â”‚  â”‚ user_id    â”‚  â”‚      â”‚  â”‚ filename   â”‚  â”‚
â”‚                  â”‚   â”‚  â”‚ filename   â”‚  â”‚      â”‚  â”‚ url (R2)   â”‚  â”‚
â”‚  [Binary Data]   â”‚   â”‚  â”‚ mime_type  â”‚  â”‚      â”‚  â”‚ title      â”‚  â”‚
â”‚                  â”‚   â”‚  â”‚ size       â”‚  â”‚      â”‚  â”‚ desc       â”‚  â”‚
â”‚  Public URL:     â”‚   â”‚  â”‚ url (R2)   â”‚  â”‚      â”‚  â”‚ youtube_id â”‚  â”‚
â”‚  https://...r2.  â”‚   â”‚  â”‚ bucket     â”‚  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  cloudflare      â”‚   â”‚  â”‚ created_at â”‚  â”‚      â”‚                  â”‚
â”‚  storage.com/... â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ Key Components

### 1. R2 Client (`lib/r2.ts`)
```typescript
S3Client({
  region: "auto",
  endpoint: R2_ENDPOINT,
  credentials: { accessKeyId, secretAccessKey }
})
```

### 2. Upload Function
```typescript
uploadToR2(buffer, key, contentType)
  â†’ PutObjectCommand
  â†’ Returns: Public URL
```

### 3. Database Tables

**files** (NEW - R2 metadata)
- id, user_id, filename, mime_type, size
- **url** (R2 URL), bucket, timestamps

**media** (EXISTING - backward compatibility)
- id, filename, **url**, title, description
- youtube_id, uploaded_by, created_at

## ğŸ”„ Alternative Flow: Direct Browser Upload

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Request presigned URL
       â”‚ POST /api/upload/presigned
       â”‚ { filename, contentType }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js    â”‚
â”‚   API        â”‚  2. Generate presigned POST
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  using AWS SDK
       â”‚ Returns: { url, fields }
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚  3. Upload directly to R2
â”‚              â”‚  POST to presigned URL
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  with FormData
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      R2      â”‚  4. File stored
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js    â”‚  5. Callback to save metadata
â”‚   API        â”‚  POST /api/files/complete
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase   â”‚  6. Metadata saved
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›¡ï¸ Security Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Request    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Authentication Check â”‚
â”‚ (if user_id passed)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File Validation      â”‚
â”‚ - Size limits        â”‚
â”‚ - Type checks        â”‚
â”‚ - Virus scan (TODO)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upload to R2         â”‚
â”‚ (server credentials) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Save to Supabase     â”‚
â”‚ - RLS enforced       â”‚
â”‚ - user_id checked    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return secure URL    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‚ File Organization in R2

```
aj247-media/
â”œâ”€â”€ media/
â”‚   â”œâ”€â”€ 1702339200000_abc123_image1.jpg
â”‚   â”œâ”€â”€ 1702339201000_def456_video1.mp4
â”‚   â””â”€â”€ 1702339202000_ghi789_photo.png
â”‚
â”œâ”€â”€ projects/
â”‚   â”œâ”€â”€ project-uuid-1/
â”‚   â”‚   â”œâ”€â”€ 1702339203000_file1.jpg
â”‚   â”‚   â””â”€â”€ 1702339204000_file2.pdf
â”‚   â”‚
â”‚   â””â”€â”€ project-uuid-2/
â”‚       â”œâ”€â”€ 1702339205000_asset1.png
â”‚       â””â”€â”€ 1702339206000_asset2.mp4
â”‚
â””â”€â”€ users/
    â”œâ”€â”€ user-uuid-1/
    â”‚   â”œâ”€â”€ profile/
    â”‚   â”‚   â””â”€â”€ avatar.jpg
    â”‚   â””â”€â”€ uploads/
    â”‚       â””â”€â”€ document.pdf
    â”‚
    â””â”€â”€ user-uuid-2/
        â””â”€â”€ profile/
            â””â”€â”€ avatar.png
```

## ğŸ’¾ Data Storage Comparison

### Before (Supabase Storage)
```
Frontend â†’ Next.js API â†’ Supabase Storage â†’ Supabase DB
                              â†“
                        Storage bucket
                        (Limited, slower)
```

### After (Cloudflare R2)
```
Frontend â†’ Next.js API â†’ Cloudflare R2 â†’ Supabase DB
                              â†“
                        R2 bucket
                        (Unlimited, faster, cheaper)
```

## âš¡ Performance Benefits

| Metric | Supabase Storage | Cloudflare R2 |
|--------|------------------|---------------|
| **Upload Speed** | Regional | Global CDN |
| **Download Speed** | Regional | Global CDN |
| **Egress Cost** | Paid | FREE |
| **Storage Cost** | $0.021/GB | $0.015/GB |
| **Scale** | Limited | Unlimited |
| **Bandwidth** | Limited | Unlimited |

## ğŸ” Environment Variables Flow

```
.env.local
    â†“
Next.js Runtime
    â†“
lib/r2.ts (S3Client initialization)
    â†“
API Routes (upload, portal upload)
    â†“
Cloudflare R2 (authenticated requests)
```

## ğŸ“Š Cost Calculation Example

### Scenario: 1000 uploads/month, 500MB each

**Cloudflare R2:**
- Storage: 500GB Ã— $0.015 = **$7.50/month**
- Class A Ops: 1000 Ã— $0.0045/1000 = **$0.004** (under free tier)
- Egress: **$0** (FREE!)
- **Total: ~$7.50/month**

**AWS S3 (for comparison):**
- Storage: 500GB Ã— $0.023 = $11.50
- PUT requests: 1000 Ã— $0.005/1000 = $0.005
- Egress: 500GB Ã— $0.09 = **$45.00**
- **Total: ~$56.50/month**

**Savings: $49/month** ğŸ‰

---

For implementation details, see `R2_IMPLEMENTATION.md`
For quick setup, see `QUICK_START.md`
